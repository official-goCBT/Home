<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>goCBT | Secure Examination Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --primary: #3d5afe;
            --text: #e0e0e0;
            --success: #4caf50;
            --error: #f44336;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            overflow-x: hidden;
            user-select: none;
        }

        .hidden { display: none !important; }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; justify-content: center;
            align-items: center; z-index: 10000; transition: opacity 0.8s;
        }
        .splash-content { text-align: center; }
        .logo-text { font-size: 3.5rem; margin: 0; font-weight: 800; letter-spacing: -1px; }
        .logo-text span { color: var(--primary); }
        .spinner {
            width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
            border-left-color: var(--primary); border-radius: 50%;
            margin: 20px auto; animation: spin 1s linear infinite;
        }
        .progress-container { width: 200px; height: 4px; background: #222; margin: 10px auto; border-radius: 2px; }
        #progress-bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }

        /* --- LAYOUT --- */
        .wrapper { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .quiz-container {
            background: var(--card); padding: 40px; border-radius: 16px;
            width: 100%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid #222; text-align: center; position: relative;
        }

        /* --- INPUTS & BUTTONS --- */
        input, select {
            width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px;
            border: 1px solid #333; background: #252525; color: #fff; box-sizing: border-box;
        }
        button {
            width: 100%; padding: 14px; margin-top: 15px; border-radius: 8px;
            border: none; font-weight: bold; cursor: pointer; transition: 0.2s;
            background: var(--primary); color: white;
        }
        button:hover { filter: brightness(1.2); transform: translateY(-1px); }

        /* --- PROCTORING --- */
        .proctor-panel { position: absolute; top: -10px; right: -160px; width: 140px; }
        .camera-box {
            width: 140px; height: 105px; background: #000; border: 2px solid var(--error);
            border-radius: 8px; overflow: hidden; position: relative;
        }
        #webcam { width: 100%; height: 100%; object-fit: cover; }
        .recording-dot {
            position: absolute; top: 5px; right: 5px; width: 8px; height: 8px;
            background: red; border-radius: 50%; animation: blink 1s infinite;
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content { background: var(--card); padding: 30px; border-radius: 12px; width: 300px; text-align: center; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <h1 class="logo-text">go<span>CBT</span></h1>
            <div class="spinner"></div>
            <div class="progress-container"><div id="progress-bar"></div></div>
            <p id="loader-text" style="font-size: 0.7rem; color: #555;">SYSTEM BOOTING...</p>
        </div>
    </div>

    <div class="wrapper">
        <div id="login-portal" class="quiz-container hidden">
            <h2 style="margin-bottom: 5px;">Portal Login</h2>
            <p id="trial-status" style="color: #666; margin-bottom: 25px; font-size: 0.85rem;">Enter credentials to begin</p>
            <input type="text" id="login-id" placeholder="Examination Number">
            <input type="password" id="login-pin" placeholder="Access PIN">
            <select id="login-subject">
                <option value="" disabled selected>Select Subject</option>
                <option value="Math">Mathematics</option>
                <option value="Science">General Science</option>
            </select>
            <button onclick="validateLogin()">Authorize Session</button>
        </div>

        <div id="instruction-screen" class="quiz-container hidden">
            <h2>Examination Rules</h2>
            <div style="text-align: left; font-size: 0.85rem; background: #111; padding: 15px; border-radius: 8px;">
                <p>• Webcam monitoring is <strong>Active</strong>.</p>
                <p>• Correct answer: <strong>+10 points</strong>.</p>
                <p>• Wrong answer: <strong>-5 points</strong> penalty.</p>
                <p>• Leaving the tab will trigger a security alert.</p>
            </div>
            <button onclick="startExamNow()">Acknowledge & Start</button>
        </div>

        <div id="quiz-screen" class="quiz-container hidden">
            <div class="proctor-panel">
                <div class="camera-box">
                    <video id="webcam" autoplay muted></video>
                    <div class="recording-dot"></div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888; margin-bottom:20px;">
                <span id="display-name"></span>
                <span id="timer" style="color:var(--error); font-weight:bold;">00:00</span>
            </div>
            <h3 id="question-text"></h3>
            <div id="options-container"></div>
        </div>

        <div id="result-screen" class="quiz-container hidden">
            <h2>Result Generated</h2>
            <h1 id="final-score" style="font-size: 3rem; margin: 10px 0;">0</h1>
            <button onclick="generatePDF()" style="background:#ff9800">Download Certificate</button>
            <button onclick="window.print()" style="background:#2196f3">Print Summary</button>
            <button onclick="location.reload()" style="background:#444">Start Over</button>
        </div>

        <div id="admin-dashboard" class="quiz-container hidden" style="max-width: 700px;">
            <h2>Master Gradebook</h2>
            <table style="width:100%; border-collapse: collapse; font-size: 0.8rem;">
                <thead style="background:#333;"><tr><th>ID</th><th>Name</th><th>Score</th><th>Date</th></tr></thead>
                <tbody id="results-body"></tbody>
            </table>
            <button onclick="location.reload()">Back to Login</button>
        </div>
    </div>

    <div id="status-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="modal-icon" style="font-size: 2rem; margin-bottom: 10px;"></div>
            <h3 id="modal-title" style="margin:0;"></h3>
            <p id="modal-msg" style="font-size:0.8rem; color:#888;"></p>
            <button id="modal-btn">Continue</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "YOUR_GOOGLE_SHEETS_URL"; // ADD YOUR URL HERE
        const activationPins = ["PREMIUM-99", "GOCBT-FREE"]; // Valid Premium Pins
        
        const studentDatabase = {
            "goCBT/ST/Demo": { name: "Demo User", pin: "1111" },
            "goCBT/ST/002": { name: "Jane Smith", pin: "2222" }
        };
        const quizData = {
            Maths_JSS2: [
                { q: "What is 25 x 4?", a: "100", options: ["80", "100", "120", "90"] },
                { q: "Square root of 144?", a: "12", options: ["10", "11", "12", "14"] }
            ],
            Basic Science_JSS1: [
                { q: "Which planet is the Red Planet?", a: "Mars", options: ["Mars", "Venus", "Jupiter", "Earth"] }
            ],
			English Language_JSS1: [
                { q: "Which of the following is a "Proper Noun"?", c: "University of Ibadan", options: ["University", "Education", "University of Ibadan", "Student"] },
				{ q: "Identify the *Collective Noun* in this sentence: The congregation listened to the sermon.", a: "Congregation", options: ["Congregation", "Listened", "Sermon", "The"] },
				{ q: "Wisdom is better than strength. In this sentence, what type of noun is *Wisdom*?", b: "Abstract Noun", options: ["Concrete Noun", "Abstract Noun", "Common Noun", "Collective Noun"] },
				{ q: "Which of these is a compound noun?", c: "Classroom", options: ["School", "Principal", "Classroom", "Teacher"] }
            ]
			{ q: "What is the plural for the Noun *Knife*?", d: "Knives", options: ["knifes", "knive", "knivess", "Knives"] },
			{ q: "Which of these nouns is of the Common Gender?", b: "Cousin", options: ["King", "Cousin", "Queen", "Table"] },
			{ q: "Identify the *Neuter Gender* noun in the list below:", c: "Computer", options: ["Lioness", "Hero", "Computer", "Servant"] },
			{ q: "Which of the following is an *Uncountable Noun?", b: "Information", options: ["Bottle", "Information", "Assignment", "Chair"] },
			{ q: "Choose the correct word to complete the sentence: How_____ sugar do you want in your tea?", c: "Much", options: ["Many", "Few", "Much", "Several"] },
			{ q: "In the sentence: Tolu gave Bisi a book. What is the *Direct Object*?", d: "Book", options: ["Tolu", "Gave", "Bisi", "Book"] }
        };

        // --- STATE ---
        let currentQuestions = [];
        let currentIdx = 0;
        let score = 0;
        let timeLeft = 600; // 10 minutes
        let timerId;

        // --- FREEMIUM HELPERS ---
        function getTrialCount() { return parseInt(localStorage.getItem("gocbt_trials") || "0"); }
        function isPremium() { return localStorage.getItem("gocbt_premium") === "true"; }

        // --- SPLASH LOGIC ---
        window.onload = () => {
            const bar = document.getElementById("progress-bar");
            let p = 0;
            const iv = setInterval(() => {
                p += 25;
                bar.style.width = p + "%";
                if(p >= 100) {
                    clearInterval(iv);
                    setTimeout(() => {
                        document.getElementById("splash-screen").style.opacity = "0";
                        setTimeout(() => {
                            document.getElementById("splash-screen").style.display = "none";
                            document.getElementById("login-portal").classList.remove("hidden");
                            updateTrialStatus();
                            checkPersistence();
                        }, 800);
                    }, 400);
                }
            }, 300);
        };

        function updateTrialStatus() {
            const statusEl = document.getElementById("trial-status");
            if (isPremium()) {
                statusEl.innerText = "Premium Access Active";
                statusEl.style.color = "var(--success)";
            } else {
                statusEl.innerText = `Free Trial: ${getTrialCount()} of 3 attempts used.`;
            }
        }

        // --- AUTH ---
        function validateLogin() {
            const id = document.getElementById("login-id").value;
            const pin = document.getElementById("login-pin").value;
            const sub = document.getElementById("login-subject").value;

            if (id === "ADMIN") { showAdmin(); return; }
            const s = studentDatabase[id];
            
            if (!s || s.pin !== pin) return showModal('error', 'Denied', 'Incorrect credentials.');
            if (!sub) return showModal('error', 'Subject', 'Choose an exam.');

            // Check Trial Limit
            if (!isPremium() && getTrialCount() >= 3) {
                promptActivation();
                return;
            }

            showModal('success', 'Verified', `Welcome, ${s.name}.`, () => {
                document.getElementById("login-portal").classList.add("hidden");
                document.getElementById("instruction-screen").classList.remove("hidden");
            });
        }

        function promptActivation() {
            showModal('error', 'Trial Expired', 'You have used your 3 free attempts. Please enter a Premium PIN to continue.', () => {
                const userPin = prompt("Enter Premium Activation PIN:");
                if (activationPins.includes(userPin)) {
                    localStorage.setItem("gocbt_premium", "true");
                    showModal('success', 'Unlocked', 'Premium activated! Unlimited attempts now available.', () => location.reload());
                } else {
                    alert("Invalid PIN.");
                }
            });
        }

        // --- EXAM LOGIC ---
        async function startExamNow() {
            const id = document.getElementById("login-id").value;
            const sub = document.getElementById("login-subject").value;
            
            // Shuffle and slice to 10 questions for free trial
            let allQ = [...quizData[sub]].sort(() => Math.random() - 0.5);
            currentQuestions = isPremium() ? allQ : allQ.slice(0, 10); 
            
            document.getElementById("display-name").innerText = studentDatabase[id].name;
            document.getElementById("instruction-screen").classList.add("hidden");
            document.getElementById("quiz-screen").classList.remove("hidden");

            try {
                const s = await navigator.mediaDevices.getUserMedia({video: true});
                document.getElementById('webcam').srcObject = s;
            } catch(e) {}

            renderQ();
            timerId = setInterval(updateTimer, 1000);
        }

        function renderQ() {
            const q = currentQuestions[currentIdx];
            document.getElementById("question-text").innerText = q.q;
            const container = document.getElementById("options-container");
            container.innerHTML = "";
            q.options.forEach(opt => {
                const b = document.createElement("button");
                b.innerText = opt;
                b.onclick = () => checkAns(opt);
                container.appendChild(b);
            });
            saveState();
        }

        function checkAns(choice) {
            if (choice === currentQuestions[currentIdx].a) score += 10;
            else score -= 5;
            
            currentIdx++;
            if (currentIdx < currentQuestions.length) renderQ();
            else finishExam();
        }

        function updateTimer() {
            timeLeft--;
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById("timer").innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
            if (timeLeft <= 0) finishExam();
        }

        function finishExam() {
            clearInterval(timerId);
            
            // Increment trial count if not premium
            if (!isPremium()) {
                let trials = getTrialCount();
                localStorage.setItem("gocbt_trials", trials + 1);
            }

            localStorage.removeItem("gocbt_state");
            document.getElementById("quiz-screen").classList.add("hidden");
            document.getElementById("result-screen").classList.remove("hidden");
            document.getElementById("final-score").innerText = score;
            syncToCloud();
        }

        // --- DATA ---
        function saveState() {
            const state = { id: document.getElementById("login-id").value, sub: document.getElementById("login-subject").value, idx: currentIdx, sc: score, time: timeLeft };
            localStorage.setItem("gocbt_state", JSON.stringify(state));
        }

        function checkPersistence() {
            const s = JSON.parse(localStorage.getItem("gocbt_state"));
            if (s) {
                if(confirm("Resume previous session?")) {
                    currentIdx = s.idx; score = s.sc; timeLeft = s.time;
                    document.getElementById("login-id").value = s.id;
                    document.getElementById("login-subject").value = s.sub;
                    startExamNow();
                } else localStorage.removeItem("gocbt_state");
            }
        }

        async function syncToCloud() {
            const data = { examNo: document.getElementById("login-id").value, name: document.getElementById("display-name").innerText, score: score, date: new Date().toLocaleString() };
            // Note: Cloud sync is only a dummy in this frontend-only example
            console.log("Syncing to Cloud:", data);
            
            // Local backup for Admin panel
            const localRes = JSON.parse(localStorage.getItem("examResults") || "[]");
            localRes.push(data);
            localStorage.setItem("examResults", JSON.stringify(localRes));
        }

        // --- UTILS ---
        function showModal(type, title, msg, callback) {
            const m = document.getElementById("status-modal");
            document.getElementById("modal-icon").innerHTML = type === 'success' ? '✅' : '❌';
            document.getElementById("modal-title").innerText = title;
            document.getElementById("modal-msg").innerText = msg;
            m.classList.remove("hidden");
            document.getElementById("modal-btn").onclick = () => { m.classList.add("hidden"); if(callback) callback(); };
        }

        function showAdmin() {
            document.getElementById("login-portal").classList.add("hidden");
            document.getElementById("admin-dashboard").classList.remove("hidden");
            const res = JSON.parse(localStorage.getItem("examResults") || "[]");
            document.getElementById("results-body").innerHTML = res.map(r => `<tr><td>${r.examNo}</td><td>${r.name}</td><td>${r.score}</td><td>${r.date}</td></tr>`).join('');
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            doc.text("GO-CBT OFFICIAL CERTIFICATE", 148, 50, {align: 'center'});
            doc.text(`Candidate: ${document.getElementById("display-name").innerText}`, 148, 70, {align: 'center'});
            doc.text(`Score: ${score}`, 148, 90, {align: 'center'});
            doc.save("Result.pdf");
        }

        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && !document.getElementById("quiz-screen").classList.contains("hidden")) alert("Warning: Leaving the tab is logged.");
        });
    </script>
</body>
</html>
